<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kompas Kiblat</title>
<style>
body{margin:0;overflow:hidden;background:#000;color:white;font-family:system-ui;}
#ui{
position:absolute;
bottom:15px;
left:50%;
transform:translateX(-50%);
background:rgba(0,0,0,0.6);
padding:12px 18px;
border-radius:15px;
font-size:13px;
text-align:center;
backdrop-filter:blur(10px);
}
button{
margin-top:6px;
padding:6px 12px;
border:none;
border-radius:10px;
background:#facc15;
font-weight:bold;
}
</style>
</head>
<body>
<div class="globe"></div>
<div id="ui">
ğŸ“ <span id="coord">Mendeteksi...</span><br>
ğŸ“ Kiblat: <span id="degree">-</span>Â° |
Selisih: <span id="diff">-</span>Â°<br>
ğŸŒ Jarak: <span id="distance">-</span> km<br>
<button onclick="toggleMode()">Mode Siang/Malam</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/FontLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/geometries/TextGeometry.js"></script>

<script>
/* ================= BASIC SETUP ================= */
const scene=new THREE.Scene();
let isNight=true;

const camera=new THREE.PerspectiveCamera(45,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,6,12);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

/* ================= HDR REFLECTION ================= */
const pmrem=new THREE.PMREMGenerator(renderer);
scene.environment=pmrem.fromScene(new THREE.Scene(),0.04).texture;

/* ================= LIGHTING ================= */
const ambient=new THREE.AmbientLight(0xffffff,0.4);
scene.add(ambient);

const movingLight=new THREE.PointLight(0xffffff,1,100);
movingLight.position.set(5,8,5);
movingLight.castShadow=true;
scene.add(movingLight);

/* ================= COMPASS BASE ================= */
const base=new THREE.Mesh(
new THREE.CylinderGeometry(5,5,0.8,64),
new THREE.MeshStandardMaterial({
color:0x1e293b,
metalness:1,
roughness:0.2
})
);
base.receiveShadow=true;
scene.add(base);

/* ================= NEEDLE ================= */
const needleGroup=new THREE.Group();

const red=new THREE.Mesh(
new THREE.BoxGeometry(0.3,0.3,4),
new THREE.MeshStandardMaterial({color:0xff0000,metalness:1,roughness:0.2})
);
red.position.z=-2;

const white=new THREE.Mesh(
new THREE.BoxGeometry(0.3,0.3,4),
new THREE.MeshStandardMaterial({color:0xffffff,metalness:1,roughness:0.3})
);
white.position.z=2;

needleGroup.add(red);
needleGroup.add(white);

/* ================= KA'BAH GLOW ================= */
const kabah=new THREE.Mesh(
new THREE.BoxGeometry(1,1,1),
new THREE.MeshStandardMaterial({color:0x000000})
);
kabah.position.z=-4.5;

const glow=new THREE.Mesh(
new THREE.SphereGeometry(1.4,32,32),
new THREE.MeshBasicMaterial({color:0xffd700,transparent:true,opacity:0.2})
);
glow.position.copy(kabah.position);

needleGroup.add(kabah);
needleGroup.add(glow);
scene.add(needleGroup);

/* ================= GLOBE ================= */
const globe=new THREE.Mesh(
new THREE.SphereGeometry(1.2,32,32),
new THREE.MeshStandardMaterial({color:0x2563eb,metalness:0.5,roughness:0.5})
);
globe.position.set(0,3,-3);
scene.add(globe);

/* ================= TEXT N E S W ================= */
const loader=new THREE.FontLoader();
loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json',font=>{
const letters=['N','E','S','W'];
const positions=[[0,0,-4.5],[4.5,0,0],[0,0,4.5],[-4.5,0,0]];
letters.forEach((l,i)=>{
const mesh=new THREE.Mesh(
new THREE.TextGeometry(l,{font,size:0.8,height:0.2}),
new THREE.MeshStandardMaterial({color:0xffffff,metalness:1,roughness:0.3})
);
mesh.position.set(positions[i][0],0.6,positions[i][2]);
mesh.rotation.x=-Math.PI/2;
scene.add(mesh);
});
});

/* ================= QIBLA LOGIC ================= */
const KAABA_LAT=21.4225;
const KAABA_LON=39.8262;
let heading=0,qibla=0,smoothRot=0,offset=0;

function toRad(d){return d*Math.PI/180;}
function toDeg(r){return r*180/Math.PI;}

function getDistance(lat1,lon1,lat2,lon2){
const R=6371;
const dLat=toRad(lat2-lat1);
const dLon=toRad(lon2-lon1);
const a=Math.sin(dLat/2)**2+
Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
Math.sin(dLon/2)**2;
return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function getQibla(lat,lon){
const dLon=toRad(KAABA_LON-lon);
const y=Math.sin(dLon);
const x=Math.cos(toRad(lat))*Math.tan(toRad(KAABA_LAT))
-Math.sin(toRad(lat))*Math.cos(dLon);
return (toDeg(Math.atan2(y,x))+360)%360;
}

/* ================= GPS ================= */
navigator.geolocation.getCurrentPosition(pos=>{
let lat=pos.coords.latitude;
let lon=pos.coords.longitude;
document.getElementById("coord").textContent=
lat.toFixed(5)+", "+lon.toFixed(5);
qibla=getQibla(lat,lon);
document.getElementById("degree").textContent=qibla.toFixed(2);
document.getElementById("distance").textContent=
getDistance(lat,lon,KAABA_LAT,KAABA_LON).toFixed(1);
});

/* ================= SENSOR ================= */
window.addEventListener("deviceorientation",e=>{
if(e.webkitCompassHeading) heading=e.webkitCompassHeading+offset;
else heading=360-e.alpha+offset;
});

/* ================= AUTO CALIBRATION ================= */
let samples=[];
setInterval(()=>{
samples.push(heading);
if(samples.length>30){
let avg=samples.reduce((a,b)=>a+b)/samples.length;
offset=-avg+heading;
samples=[];
}
},500);

/* ================= MODE TOGGLE ================= */
function toggleMode(){
isNight=!isNight;
scene.background=new THREE.Color(isNight?0x000000:0x87ceeb);
}

/* ================= ANIMATION ================= */
function animate(){
requestAnimationFrame(animate);

movingLight.position.x=Math.sin(Date.now()*0.001)*8;

let target=(qibla-heading);
smoothRot+=(target-smoothRot)*0.05;

needleGroup.rotation.y=toRad(smoothRot);

globe.rotation.y+=0.003;

document.getElementById("diff").textContent=
Math.abs(target).toFixed(1);

renderer.render(scene,camera);
}
animate();

window.addEventListener("resize",()=>{
camera.aspect=innerWidth/innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(innerWidth,innerHeight);
});
</script>

</body>
</html>
