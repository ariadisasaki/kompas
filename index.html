<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kompas Kiblat 3D Premium</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
body{
    margin:0;
    background:radial-gradient(circle at top,#0f172a,#020617);
    color:white;
    font-family:system-ui;
    display:flex;
    flex-direction:column;
    align-items:center;
}

#compass{
    width:340px;
    height:340px;
    margin-top:30px;
    position:relative;
    perspective:1000px;
}

.disk{
    width:100%;
    height:100%;
    border-radius:50%;
    background:linear-gradient(145deg,#1e293b,#0f172a);
    box-shadow:
        inset 0 0 40px rgba(255,255,255,0.05),
        0 20px 40px rgba(0,0,0,0.6);
    position:absolute;
}

.cardinal{
    position:absolute;
    font-weight:bold;
    font-size:28px;
    text-shadow:0 3px 6px black;
}

.N{top:10px;left:50%;transform:translateX(-50%);}
.S{bottom:10px;left:50%;transform:translateX(-50%);}
.E{right:10px;top:50%;transform:translateY(-50%);}
.W{left:10px;top:50%;transform:translateY(-50%);}

#needle{
    width:6px;
    height:160px;
    position:absolute;
    top:50%;
    left:50%;
    transform-origin:50% 100%;
    transform:translate(-50%,-100%) rotate(0deg);
    transition:transform 0.1s linear;
}

.red{
    background:linear-gradient(to top,#b91c1c,#ef4444);
    height:50%;
}

.white{
    background:linear-gradient(to bottom,#ffffff,#cbd5e1);
    height:50%;
}

.kabah{
    width:18px;
    height:18px;
    background:black;
    border:2px solid gold;
    position:absolute;
    top:-10px;
    left:50%;
    transform:translateX(-50%);
    box-shadow:0 0 10px gold;
}

.info{
    margin-top:25px;
    text-align:center;
    font-size:14px;
    line-height:1.6;
    opacity:0.9;
}

.globe{
    width:60px;
    height:60px;
    border-radius:50%;
    background:radial-gradient(circle at 30% 30%,#3b82f6,#0ea5e9,#1e3a8a);
    margin-top:15px;
    box-shadow:0 0 15px #0ea5e9;
}
button{
    margin-top:15px;
    padding:10px 18px;
    border:none;
    border-radius:20px;
    background:#22c55e;
    color:black;
    font-weight:bold;
}
</style>
</head>
<body>

<h2>üïã Kompas Kiblat 3D</h2>

<div id="compass">
    <div class="disk"></div>
    <div class="cardinal N">N</div>
    <div class="cardinal E">E</div>
    <div class="cardinal S">S</div>
    <div class="cardinal W">W</div>

    <div id="needle">
        <div class="red"></div>
        <div class="white"></div>
        <div class="kabah"></div>
    </div>
</div>

<div class="info">
    üìç Koordinat: <span id="coord">-</span><br>
    üìê Derajat Kiblat: <span id="degree">-</span>¬∞<br>
    üß≠ Selisih Sudut: <span id="diff">-</span>¬∞<br>
    üåç Jarak ke Mekkah: <span id="distance">-</span> km
</div>

<button onclick="requestPermission()">Aktifkan Sensor</button>

<script>
/* =========================
   KONFIGURASI KA'BAH
========================= */
const KAABA_LAT = 21.4225;
const KAABA_LON = 39.8262;

/* =========================
   VAR GLOBAL
========================= */
let userLat = null;
let userLon = null;
let heading = 0;
let qibla = 0;
let smoothRotation = 0;
let sensorAvailable = false;

/* =========================
   UTIL
========================= */
function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }

function normalize(angle){
    return (angle+360)%360;
}

/* =========================
   HITUNG JARAK (HAVERSINE)
========================= */
function getDistance(lat1,lon1,lat2,lon2){
    const R=6371;
    const dLat=toRad(lat2-lat1);
    const dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2+
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
            Math.sin(dLon/2)**2;
    return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

/* =========================
   HITUNG ARAH KIBLAT
========================= */
function getQibla(lat,lon){
    const dLon=toRad(KAABA_LON-lon);
    const y=Math.sin(dLon);
    const x=Math.cos(toRad(lat))*Math.tan(toRad(KAABA_LAT))
            -Math.sin(toRad(lat))*Math.cos(dLon);
    return normalize(toDeg(Math.atan2(y,x)));
}

/* =========================
   GPS AUTO LOAD
========================= */
function loadGPS(){
    if(!navigator.geolocation){
        document.getElementById("coord").textContent="GPS tidak didukung";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos=>{
            userLat=pos.coords.latitude;
            userLon=pos.coords.longitude;

            document.getElementById("coord").textContent=
                userLat.toFixed(5)+", "+userLon.toFixed(5);

            qibla=getQibla(userLat,userLon);
            document.getElementById("degree").textContent=
                qibla.toFixed(2);

            let dist=getDistance(userLat,userLon,KAABA_LAT,KAABA_LON);
            document.getElementById("distance").textContent=
                dist.toFixed(1);

        },
        err=>{
            document.getElementById("coord").textContent=
                "Aktifkan lokasi & HTTPS";
        },
        {enableHighAccuracy:true,timeout:10000}
    );
}

/* =========================
   SENSOR AUTO DETECT
========================= */
function initSensor(){

    if(window.DeviceOrientationEvent){

        window.addEventListener("deviceorientation",(e)=>{

            if(e.webkitCompassHeading){ 
                heading = e.webkitCompassHeading;
            }
            else if(e.alpha!=null){
                heading = 360 - e.alpha;
            }

            heading = normalize(heading);
            sensorAvailable = true;

        },true);
    }
}

/* =========================
   ANIMASI SUPER HALUS
========================= */
function animate(){

    let target = normalize(qibla - heading);

    let diff = target - smoothRotation;

    if(diff > 180) diff -= 360;
    if(diff < -180) diff += 360;

    smoothRotation += diff * 0.05; // semakin kecil semakin halus

    document.getElementById("needle").style.transform=
        `translate(-50%,-100%) rotate(${smoothRotation}deg)`;

    document.getElementById("diff").textContent=
        Math.abs(diff).toFixed(2);

    requestAnimationFrame(animate);
}

/* =========================
   START SYSTEM
========================= */
loadGPS();
initSensor();
animate();

/* =========================
   ANTI ERROR VISIBILITY
========================= */
window.onerror=function(){
    console.log("Error ditangani");
    return true;
};
</script>

<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
}
</script>

</body>
</html>
