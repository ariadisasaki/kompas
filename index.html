<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kompas Kiblat</title>
<meta name="theme-color" content="#0f172a">

<style>
body{
    margin:0;
    overflow:hidden;
    background:#020617;
    font-family:system-ui;
    color:white;
}
#info{
    position:absolute;
    bottom:15px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.6);
    padding:12px 18px;
    border-radius:15px;
    font-size:13px;
    text-align:center;
    backdrop-filter:blur(10px);
}
</style>
</head>
<body>

<div id="info">
ğŸ“ <span id="coord">Mendeteksi lokasi...</span><br>
ğŸ“ Kiblat: <span id="degree">-</span>Â° |
Selisih: <span id="diff">-</span>Â°<br>
ğŸŒ Jarak: <span id="distance">-</span> km
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<script>
/* ============================
   BASIC SCENE SETUP
============================ */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x020617);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,6,10);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

/* ============================
   LIGHTING REALISTIS
============================ */
const ambient = new THREE.AmbientLight(0xffffff,0.4);
scene.add(ambient);

const dirLight = new THREE.DirectionalLight(0xffffff,1);
dirLight.position.set(5,10,7);
dirLight.castShadow = true;
scene.add(dirLight);

/* ============================
   COMPASS BASE (METAL)
============================ */
const baseGeo = new THREE.CylinderGeometry(5,5,0.8,64);
const baseMat = new THREE.MeshStandardMaterial({
    color:0x1e293b,
    metalness:0.9,
    roughness:0.3
});
const base = new THREE.Mesh(baseGeo,baseMat);
base.receiveShadow = true;
scene.add(base);

/* ============================
   NEEDLE 3D
============================ */
const needleGroup = new THREE.Group();

const redMat = new THREE.MeshStandardMaterial({color:0xff0000, metalness:0.8, roughness:0.2});
const whiteMat = new THREE.MeshStandardMaterial({color:0xffffff, metalness:0.7, roughness:0.3});

const redNeedle = new THREE.Mesh(
    new THREE.BoxGeometry(0.3,0.3,4),
    redMat
);
redNeedle.position.z = -2;

const whiteNeedle = new THREE.Mesh(
    new THREE.BoxGeometry(0.3,0.3,4),
    whiteMat
);
whiteNeedle.position.z = 2;

needleGroup.add(redNeedle);
needleGroup.add(whiteNeedle);

/* ============================
   KA'BAH 3D
============================ */
const kabahMat = new THREE.MeshStandardMaterial({
    color:0x000000,
    metalness:0.3,
    roughness:0.8
});
const kabah = new THREE.Mesh(
    new THREE.BoxGeometry(0.8,0.8,0.8),
    kabahMat
);
kabah.position.z = -4.5;
needleGroup.add(kabah);

scene.add(needleGroup);

/* ============================
   GLOBE
============================ */
const globe = new THREE.Mesh(
    new THREE.SphereGeometry(1.2,32,32),
    new THREE.MeshStandardMaterial({
        color:0x2563eb,
        metalness:0.4,
        roughness:0.6
    })
);
globe.position.set(0,3,-3);
scene.add(globe);

/* ============================
   QIBLA LOGIC
============================ */
const KAABA_LAT=21.4225;
const KAABA_LON=39.8262;

let heading=0;
let qibla=0;
let smoothRot=0;

function toRad(d){return d*Math.PI/180;}
function toDeg(r){return r*180/Math.PI;}

function getDistance(lat1,lon1,lat2,lon2){
 const R=6371;
 const dLat=toRad(lat2-lat1);
 const dLon=toRad(lon2-lon1);
 const a=Math.sin(dLat/2)**2+
 Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
 Math.sin(dLon/2)**2;
 return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function getQibla(lat,lon){
 const dLon=toRad(KAABA_LON-lon);
 const y=Math.sin(dLon);
 const x=Math.cos(toRad(lat))*Math.tan(toRad(KAABA_LAT))
 -Math.sin(toRad(lat))*Math.cos(dLon);
 return (toDeg(Math.atan2(y,x))+360)%360;
}

/* ============================
   GPS
============================ */
navigator.geolocation.getCurrentPosition(pos=>{
 let lat=pos.coords.latitude;
 let lon=pos.coords.longitude;

 document.getElementById("coord").textContent=
 lat.toFixed(5)+", "+lon.toFixed(5);

 qibla=getQibla(lat,lon);
 document.getElementById("degree").textContent=
 qibla.toFixed(2);

 let dist=getDistance(lat,lon,KAABA_LAT,KAABA_LON);
 document.getElementById("distance").textContent=
 dist.toFixed(1);

});

/* ============================
   SENSOR
============================ */
window.addEventListener("deviceorientation",e=>{
 if(e.webkitCompassHeading){
 heading=e.webkitCompassHeading;
 }else{
 heading=360-e.alpha;
 }
});

/* ============================
   ANIMATION LOOP
============================ */
function animate(){
 requestAnimationFrame(animate);

 let target=(qibla-heading);
 smoothRot+= (target-smoothRot)*0.05;

 needleGroup.rotation.y=toRad(smoothRot);

 globe.rotation.y+=0.003;

 document.getElementById("diff").textContent=
 Math.abs(target).toFixed(1);

 renderer.render(scene,camera);
}
animate();

/* ============================
   RESPONSIVE
============================ */
window.addEventListener("resize",()=>{
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
});
</script>

</body>
</html>
